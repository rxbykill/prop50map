<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CA — Precinct Leading-Party (Intensity by Total Votes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{position:absolute;inset:0}
    .toggle{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,.92);padding:8px 10px;border-radius:10px;
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:3;display:flex;gap:8px}
    .btn{appearance:none;border:1px solid #ccc;background:#fff;padding:6px 10px;
      border-radius:10px;cursor:pointer;font:14px/1.2 inherit;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .btn:hover{background:#f6f6f6}
    .legend-box{position:absolute;z-index:3;bottom:12px;left:12px;
      background:rgba(255,255,255,.92);border-radius:10px;padding:10px 12px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;min-width:260px}
    .legend-title{font-weight:600;margin-bottom:6px}
    .legend-row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .legend-note{font-size:12px;color:#555;margin-top:4px}
    .grad{height:14px;border-radius:4px}
    .grad-diverging{width:220px;background:linear-gradient(to right,
      #a50f15 0%, #de2d26 20%, #fb6a4a 40%, #ffffff 50%, #deebf7 60%, #9ecae1 80%, #08519c 100%);
      border:1px solid rgba(0,0,0,.1)}
    .legend-dim{opacity:.35}
    .legend-spread{justify-content:space-between;width:220px;font-size:12px;color:#333}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="toggle">
    <button id="btn-toggle" class="btn" type="button">Switch to 2020</button>
  </div>

  <div class="legend-box">
    <div class="legend-title">Leading Candidate in the 2024 Election</div>
    <div class="legend-row"><div class="grad grad-diverging"></div></div>
    <div class="legend-row legend-spread"><span>Trump</span><span></span><span>Harris</span></div>
    <div class="legend-note">Voter concentration by precinct.</div>
  </div>

  <script>
    // ---- CONFIG ----
    mapboxgl.accessToken = 'pk.eyJ1IjoicnV0aG5maW5jaCIsImEiOiJjbWgybDA2aG8ydnFpMm5uYWVqMWZ3bW5kIn0.zQCyDxihQ-jyA36Wiy-TRw';
    const PROP50_TILESET_URL = 'mapbox://ruthnfinch.63ohl3tk';   // uses DISTRICT
    const Y2020_TILESET_URL  = 'mapbox://ruthnfinch.2jy7hxhc';   // uses DISTRICT_N
    const TRACTS_TILESET_URL = 'mapbox://ruthnfinch.bcdd0f0k';
    const TRACTS_SOURCE_LAYER = 'CAprecinctswithresults1';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-119.5, 37.1],
      zoom: 5
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // Winner & intensity (by total votes)
    const dem   = ['to-number', ['get','votes_dem']];
    const rep   = ['to-number', ['get','votes_rep']];
    const total = ['coalesce', ['to-number',['get','votes_total']], ['+', dem, rep]];
    const HAS_VOTE_FIELDS = ['any', ['has','votes_total'], ['has','votes_dem'], ['has','votes_rep']];

    const BLUE_RAMP=['interpolate',['exponential',1.4],total,
      0,'#e8f1fb',50,'#c4dcf6',250,'#8bbaf0',1000,'#4e93e0',3000,'#1e6fd1',6000,'#0e3f91'];
    const RED_RAMP =['interpolate',['exponential',1.4],total,
      0,'#fdeaea',50,'#facdcd',250,'#f29b9b',1000,'#e35d5d',3000,'#c62828',6000,'#7f0000'];

    const FILL_COLOR_EXPR=[
      'case',
        ['all', HAS_VOTE_FIELDS, ['>', dem, rep]], BLUE_RAMP,
        ['all', HAS_VOTE_FIELDS, ['>', rep, dem]], RED_RAMP,
        '#f0f0f0'
    ];

    function debounce(fn, wait=200){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    map.on('load', async ()=> {
      const before=(map.getStyle().layers.find(l=>l.type==='symbol')||{}).id;

     
      map.addSource('prop50',{type:'vector',url:PROP50_TILESET_URL});
      map.addSource('y2020',{type:'vector',url:Y2020_TILESET_URL});
      map.addSource('tracts',{type:'vector',url:TRACTS_TILESET_URL});

  
      const [prop50Layer, y2020Layer] = await Promise.all([
        fetch(`https://api.mapbox.com/v4/ruthnfinch.63ohl3tk.json?secure&access_token=${mapboxgl.accessToken}`).then(r=>r.json()).then(j=>j.vector_layers[0].id),
        fetch(`https://api.mapbox.com/v4/ruthnfinch.2jy7hxhc.json?secure&access_token=${mapboxgl.accessToken}`).then(r=>r.json()).then(j=>j.vector_layers[0].id)
      ]);

   
      map.addLayer({
        id:'tracts-fill', type:'fill', source:'tracts', 'source-layer': TRACTS_SOURCE_LAYER,
        filter: HAS_VOTE_FIELDS,
        paint:{ 'fill-color': FILL_COLOR_EXPR, 'fill-opacity': 0.7 }
      }, before);

      
      map.addLayer({
        id:'prop50-line', type:'line', source:'prop50', 'source-layer': prop50Layer,
        paint:{ 'line-color':'#ffae00','line-width':2.8,'line-opacity':1.0,'line-dasharray':[1,0] }
      }, before);

      map.addLayer({
        id:'y2020-line', type:'line', source:'y2020', 'source-layer': y2020Layer,
        paint:{ 'line-color':'#ffae00','line-width':1.8,'line-opacity':0.5,'line-dasharray':[2,2] }
      }, before);

      
      map.addLayer({ id:'prop50-fill-hit', type:'fill', source:'prop50','source-layer':prop50Layer,
        paint:{'fill-opacity':0} }, before);
      map.addLayer({ id:'y2020-fill-hit', type:'fill', source:'y2020','source-layer':y2020Layer,
        paint:{'fill-opacity':0} }, before);

      
      map.addSource('district-centroids', {
        type: 'geojson',
        data: { type:'FeatureCollection', features:[] }
      });

      
      map.addLayer({
        id: 'district-centroid-labels',
        type: 'symbol',
        source: 'district-centroids',
        layout: {
          'text-field': ['get','label'],
          'text-size': ['interpolate',['linear'],['zoom'],5,16,7,20,9,24,11,28],
          'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
          'text-allow-overlap': false,
          'text-optional': true,
          'symbol-placement': 'point',
          'text-justify': 'center'
        },
        paint: {
          'text-color': '#202020',
          'text-halo-color': '#ffffff',
          'text-halo-width': 2,
          'text-opacity': 0.95
        }
      }, before);

      
      const centroidCache = {
        prop50: new Map(),   // id -> feature
        y2020:  new Map()
      };

      function setLineStyles(){
        if(focus==='prop50'){
          map.setPaintProperty('prop50-line','line-dasharray',[1,0]);
          map.setPaintProperty('prop50-line','line-width',2.8);
          map.setPaintProperty('prop50-line','line-opacity',1.0);
    
          map.setPaintProperty('y2020-line','line-dasharray',[2,2]);
          map.setPaintProperty('y2020-line','line-width',1.8);
          map.setPaintProperty('y2020-line','line-opacity',0.5);
        } else {
        
          map.setPaintProperty('y2020-line','line-dasharray',[1,0]);
          map.setPaintProperty('y2020-line','line-width',2.8);
          map.setPaintProperty('y2020-line','line-opacity',1.0);
          
          map.setPaintProperty('prop50-line','line-dasharray',[2,2]);
          map.setPaintProperty('prop50-line','line-width',1.8);
          map.setPaintProperty('prop50-line','line-opacity',0.5);
        }
      }

   
      function addCentroidsForVisibleDistricts(){
        const activeHitLayer = (focus==='prop50') ? 'prop50-fill-hit' : 'y2020-fill-hit';
        const labelField     = (focus==='prop50') ? 'DISTRICT'       : 'DISTRICT_N';
        const cache          = (focus==='prop50') ? centroidCache.prop50 : centroidCache.y2020;

      
        const feats = map.queryRenderedFeatures({ layers:[activeHitLayer] });

        for(const f of feats){
          const props = f.properties || {};
          const id = props[labelField] ?? props[labelField && labelField.toLowerCase()];
          if(id == null || cache.has(id)) continue;
          try {
            const poly = f.toJSON ? f.toJSON() : f;
            const center = turf.centerOfMass(poly.geometry && poly.geometry.type ? poly : f);
            const pt = {
              type:'Feature',
              geometry:center.geometry,
              properties:{ label: String(id), id: String(id) }
            };
            cache.set(id, pt);
          } catch(e){ /* skip bad geometries */ }
        }
      }

      function refreshCentroidSource(){
        const cache = (focus==='prop50') ? centroidCache.prop50 : centroidCache.y2020;
        const features = Array.from(cache.values());
        map.getSource('district-centroids').setData({ type:'FeatureCollection', features });
      }

      const growCacheAndRefresh = debounce(function(){
        addCentroidsForVisibleDistricts();
        refreshCentroidSource();
      }, 100);

 
      let focus='prop50';
      const btn=document.getElementById('btn-toggle');
      function updateButton(){ btn.textContent = (focus==='prop50') ? 'Switch to 2020' : 'Switch to Current'; }

      function applyFocus(){
        setLineStyles();
        updateButton();
      
        addCentroidsForVisibleDistricts();
        refreshCentroidSource();
      }

      btn.addEventListener('click',()=>{ focus=(focus==='prop50')?'y2020':'prop50'; applyFocus(); });

     
      map.on('moveend', growCacheAndRefresh);

     
      applyFocus();

      // ---- Tooltip (Dem/Rep/Total) over precincts fill
      const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
      const fmt = n => (n===null || n===undefined || isNaN(n)) ? '—' : Number(n).toLocaleString();
      const pct = (a,t) => (t>0) ? Math.round((a/t)*100) : 0;

      map.on('mousemove','tracts-fill',(e)=>{
        const f=e.features&&e.features[0]; if(!f){ popup.remove(); return; }
        const p=f.properties||{};
        const demV=Number(p.votes_dem)||0;
        const repV=Number(p.votes_rep)||0;
        const totalV=Number(p.votes_total)||(demV+repV);
        const winner=demV>repV?'<strong>Kamala Harris</strong>':(repV>demV?'<strong>Donald Trump</strong>':'<strong>Tie</strong>');

        const html = `
          <div style="font:13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;min-width:150px;">
            <div style="font-weight:600;margin-bottom:2px;">${winner}</div>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:2px 5px;">
              <div>Total votes:</div><div><strong>${fmt(totalV)}</strong></div>
              <div>Kamala Harris:</div><div><strong>${fmt(demV)}</strong> (${pct(demV,totalV)}%)</div>
              <div>Donald Trump:</div><div><strong>${fmt(repV)}</strong> (${pct(repV,totalV)}%)</div>
            </div>
          </div>`;

        popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
        map.getCanvas().style.cursor='pointer';
      });

      map.on('mouseleave','tracts-fill',()=>{ popup.remove(); map.getCanvas().style.cursor=''; });
    });
  </script>
</body>
</html>
